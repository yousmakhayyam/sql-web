name: Deploy Node App with Azure SQL

on:
  push:
    branches:
      - main

env:
  AZURE_RG: yousma-rg
  LOCATION: eastus
  BICEP_FILE: infra/main.bicep
  PARAMS_FILE: infra/parameters.json

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy Bicep Template
      uses: azure/arm-deploy@v1
      with:
        scope: resourcegroup
        resourceGroupName: ${{ env.AZURE_RG }}
        template: ${{ env.BICEP_FILE }}
        parameters: ${{ env.PARAMS_FILE }}

    - name: Get SQL connection string from Bicep output
      id: get_output
      run: |
        echo "conn_string=$(az deployment group show \
          --resource-group $AZURE_RG \
          --name $(date +%s) \
          --query "properties.outputs.sqlConnStr.value" -o tsv)" >> $GITHUB_ENV

    - name: Set app settings with SQL connection string
      run: |
        az webapp config appsettings set \
          --resource-group $AZURE_RG \
          --name yousma-web \
          --settings DB_CONNECTION="$conn_string"

    - name: Deploy Web App code
      uses: azure/webapps-deploy@v2
      with:
        app-name: yousma-web
        package: .
