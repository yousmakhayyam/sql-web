name: Deploy Azure web App with SQL

on:
  push:
    branches:
      - main

env:
  RESOURCE_GROUP: yousma-rg
  LOCATION: centralus
  SQL_ADMIN: ${{ secrets.SQL_ADMIN }}
  SQL_PASSWORD: ${{ secrets.SQL_PASSWORD }}
  SQL_DB_NAME: yousmadb1
  WEBAPP_NAME: azure-web-app
  SQL_SERVER_NAME: yousmaserver1-${{ github.run_number }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy Infrastructure (Bicep)
      uses: azure/arm-deploy@v1
      with:
        resourceGroupName: ${{ env.RESOURCE_GROUP }}
        template: infra/main.bicep
        parameters: >
          location=${{ env.LOCATION }}
          sqlServerName=${{ env.SQL_SERVER_NAME }}
          sqlAdmin=${{ env.SQL_ADMIN }}
          sqlPassword=${{ env.SQL_PASSWORD }}
          databaseName=${{ env.SQL_DB_NAME }}
          webAppName=${{ env.WEBAPP_NAME }}

    - name: Deploy Node.js App to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.WEBAPP_NAME }}
        package: ./app
